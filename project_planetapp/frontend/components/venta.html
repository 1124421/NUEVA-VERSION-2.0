<style>
    .form-card {
        background: white;
        border-radius: 6px;
        padding: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        margin-bottom: 12px;
    }

    .info-box {
        background: #e8f5e9;
        border: 1px solid #2d5a47;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
    }

    .info-box h6 {
        margin: 0 0 8px 0;
        color: #2d5a47;
        font-weight: 700;
        font-size: 13px;
    }

    .info-box p {
        margin: 3px 0;
        font-size: 12px;
        color: #333;
    }

    .search-box {
        position: relative;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 4px;
    }

    .search-results.show {
        display: block;
    }

    .search-result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .material-row {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
    }

    .material-row .material-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .btn-remove {
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 11px;
        cursor: pointer;
    }
</style>

<!-- Simple Header: Module Name | User Profile -->
<div
    style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; margin-bottom: 16px;">
    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #2d5a47;">Registro de Ventas</h2>
    <div style="display: flex; align-items: center; gap: 10px;">
        <div
            style="width: 32px; height: 32px; border-radius: 50%; background: var(--verde-renacer); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">
            U
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; font-weight: 600; color: #333;" id="ventaUserName"></div>
            <div style="font-size: 10px; color: #666;">Usuario</div>
        </div>
    </div>
</div>

<!-- Formulario de Venta -->
<div class="form-card">
    <h5 class="mb-3">
        <i data-lucide="plus-circle" style="width: 18px; height: 18px; color: var(--verde-renacer);"></i>
        Nueva Venta
    </h5>

    <form id="formVenta">
        <!-- Buscador de Cliente -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Buscar Cliente</label>
            <div class="search-box">
                <input type="text" class="form-control" id="searchCliente"
                    placeholder="Buscar por nombre o documento..." autocomplete="off">
                <div class="search-results" id="clienteResults"></div>
            </div>
            <input type="hidden" id="clienteId">
        </div>

        <!-- Información del Cliente Seleccionado -->
        <div id="clienteInfo" style="display: none;">
            <div class="info-box">
                <h6><i data-lucide="user" style="width: 14px; height: 14px;"></i> Información del Cliente</h6>
                <p><strong>Nombre:</strong> <span id="infoClienteNombre"></span></p>
                <p><strong>Documento:</strong> <span id="infoClienteDoc"></span></p>
                <p><strong>Teléfono:</strong> <span id="infoClienteTel"></span></p>
            </div>
        </div>

        <!-- Buscador de Materiales -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Agregar Materiales (Máximo 10)</label>
            <div class="search-box">
                <input type="text" class="form-control" id="searchMaterial" placeholder="Buscar material..."
                    autocomplete="off">
                <div class="search-results" id="materialResults"></div>
            </div>
            <small class="text-muted">Materiales agregados: <span id="contadorMateriales">0</span>/10</small>
        </div>

        <!-- Lista de Materiales Seleccionados -->
        <div id="materialesVenta" class="mb-3">
            <!-- Materiales aparecerán aquí -->
        </div>

        <!-- Total -->
        <div class="mb-3">
            <h5>Total: $<span id="totalVenta">0.00</span></h5>
        </div>

        <button type="submit" class="btn btn-primary">
            <i data-lucide="save" style="width: 16px; height: 16px;"></i>
            Registrar Venta
        </button>
    </form>
</div>

<!-- Tabla de Ventas -->
<div class="form-card">
    <h5 class="mb-3">
        <i data-lucide="list" style="width: 18px; height: 18px; color: var(--verde-renacer);"></i>
        Ventas Registradas
    </h5>

    <table id="ventasTable" class="table table-hover" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total Kg</th>
                <th>Total $</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            <!-- Ventas se cargarán dinámicamente desde el backend -->
        </tbody>
    </table>
</div>

<script>
    // Datos de ejemplo
    const clientesData = [
        { id: 1, nombre: 'Juan Pérez', documento: '12345678', telefono: '555-0101', correo: 'juan@example.com', activo: true },
        { id: 2, nombre: 'Ana López', documento: '87654321', telefono: '555-0102', correo: 'ana@example.com', activo: true },
        { id: 3, nombre: 'Carlos Martínez', documento: '11223344', telefono: '555-0103', correo: 'carlos@example.com', activo: false }
    ];

    const materialesData = [
        { id: 1, nombre: 'Plástico PET', precioVenta: 3.00, stock: 150, activo: true },
        { id: 2, nombre: 'Cartón', precioVenta: 2.00, stock: 200, activo: true },
        { id: 3, nombre: 'Vidrio', precioVenta: 2.50, stock: 100, activo: true },
        { id: 4, nombre: 'Aluminio', precioVenta: 15.00, stock: 50, activo: true },
        { id: 5, nombre: 'Papel', precioVenta: 1.50, stock: 300, activo: true },
        { id: 6, nombre: 'Plástico HDPE', precioVenta: 4.00, stock: 120, activo: true },
        { id: 7, nombre: 'Cobre', precioVenta: 20.00, stock: 30, activo: false }
    ];

    let materialesVenta = [];
    let clienteSeleccionado = null;

    // Buscador de clientes
    document.getElementById('searchCliente').addEventListener('input', function (e) {
        const query = e.target.value.toLowerCase();
        const results = document.getElementById('clienteResults');

        if (query.length < 2) {
            results.classList.remove('show');
            return;
        }

        const filtered = clientesData.filter(c =>
            (c.nombre.toLowerCase().includes(query) || c.documento.includes(query)) && (c.activo !== false)
        );

        results.innerHTML = filtered.map(c => `
      <div class="search-result-item" onclick="selectCliente(${c.id})">
        <strong>${c.nombre}</strong><br>
        <small class="text-muted">Doc: ${c.documento} | Tel: ${c.telefono}</small>
      </div>
    `).join('');

        results.classList.add('show');
    });

    function selectCliente(id) {
        const cliente = clientesData.find(c => c.id === id);
        if (!cliente) return;

        clienteSeleccionado = cliente;
        document.getElementById('clienteId').value = id;
        document.getElementById('searchCliente').value = cliente.nombre;
        document.getElementById('clienteResults').classList.remove('show');

        // Mostrar información del cliente
        document.getElementById('clienteInfo').style.display = 'block';
        document.getElementById('infoClienteNombre').textContent = cliente.nombre;
        document.getElementById('infoClienteDoc').textContent = cliente.documento;
        document.getElementById('infoClienteTel').textContent = cliente.telefono;

        lucide.createIcons();
    }

    // Buscador de materiales
    document.getElementById('searchMaterial').addEventListener('input', function (e) {
        const query = e.target.value.toLowerCase();
        const results = document.getElementById('materialResults');

        if (query.length < 2) {
            results.classList.remove('show');
            return;
        }

        const filtered = materialesData.filter(m =>
            m.nombre.toLowerCase().includes(query) && (m.activo !== false)
        );

        results.innerHTML = filtered.map(m => `
      <div class="search-result-item" onclick="addMaterial(${m.id})">
        <strong>${m.nombre}</strong> - $${m.precioVenta.toFixed(2)}/kg<br>
        <small class="text-muted">Stock: ${m.stock} kg</small>
      </div>
    `).join('');

        results.classList.add('show');
    });

    function addMaterial(id) {
        if (materialesVenta.length >= 10) {
            alert('Máximo 10 materiales permitidos');
            return;
        }

        if (materialesVenta.find(m => m.id === id)) {
            alert('Este material ya fue agregado');
            return;
        }

        const material = materialesData.find(m => m.id === id);
        if (!material) return;

        materialesVenta.push({
            id: material.id,
            nombre: material.nombre,
            precio: material.precioVenta,
            peso: 0
        });

        renderMateriales();
        document.getElementById('searchMaterial').value = '';
        document.getElementById('materialResults').classList.remove('show');
    }

    function renderMateriales() {
        const container = document.getElementById('materialesVenta');
        container.innerHTML = materialesVenta.map((m, index) => `
      <div class="material-row">
        <div class="material-info">
          <div>
            <strong>${m.nombre}</strong><br>
            <small class="text-muted">Precio: $${m.precio.toFixed(2)}/kg</small>
          </div>
          <button type="button" class="btn-remove" onclick="removeMaterial(${index})">
            <i data-lucide="x" style="width: 12px; height: 12px;"></i> Quitar
          </button>
        </div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label" style="font-size: 12px;">Peso (kg)</label>
            <input type="number" class="form-control form-control-sm" 
                   value="${m.peso}" min="0" step="0.1" 
                   onchange="updatePeso(${index}, this.value)"
                   placeholder="0.0">
          </div>
          <div class="col-md-6">
            <label class="form-label" style="font-size: 12px;">Subtotal</label>
            <input type="text" class="form-control form-control-sm" 
                   value="$${(m.peso * m.precio).toFixed(2)}" readonly>
          </div>
        </div>
      </div>
    `).join('');

        document.getElementById('contadorMateriales').textContent = materialesVenta.length;
        lucide.createIcons();
        calcularTotal();
    }

    function updatePeso(index, value) {
        materialesVenta[index].peso = parseFloat(value) || 0;
        renderMateriales();
    }

    function removeMaterial(index) {
        materialesVenta.splice(index, 1);
        renderMateriales();
    }

    function calcularTotal() {
        const total = materialesVenta.reduce((sum, m) => sum + (m.peso * m.precio), 0);
        document.getElementById('totalVenta').textContent = total.toFixed(2);
    }

    // Formulario
    document.getElementById('formVenta').addEventListener('submit', function (e) {
        e.preventDefault();

        if (!clienteSeleccionado) {
            alert('Debe seleccionar un cliente');
            return;
        }

        if (materialesVenta.length === 0) {
            alert('Debe agregar al menos un material');
            return;
        }

        const totalKg = materialesVenta.reduce((sum, m) => sum + m.peso, 0);
        const totalPrecio = materialesVenta.reduce((sum, m) => sum + (m.peso * m.precio), 0);

        console.log('Venta registrada:', {
            cliente: clienteSeleccionado,
            materiales: materialesVenta,
            totalKg,
            totalPrecio
        });

        alert('Venta registrada exitosamente!');

        // Limpiar
        this.reset();
        materialesVenta = [];
        clienteSeleccionado = null;
        document.getElementById('clienteInfo').style.display = 'none';
        renderMateriales();
    });

    // DataTable
    $(document).ready(function () {
        $('#ventasTable').DataTable({
            language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
            pageLength: 10
        });
    });

    lucide.createIcons();
</script>